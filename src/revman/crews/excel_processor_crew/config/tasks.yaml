parse_excel_file:
  description: |
    Parse the Excel file at {excel_file_path} and extract all price change records.

    INSTRUCTIONS:
    - Skip the first 7 rows, row 8 contains headers, data starts at row 9
    - Extract all columns including:
      * SAP Art. No. (Article Number)
      * Type of Sale
      * Brewer
      * Product Name
      * Pack Type (Bottles/Cans)
      * Pack Volume (ml)
      * Package Full Name
      * Pack Size
      * Old Price
      * New Price
      * Increase/(Decrease)
    - Handle data type conversions (numbers, text, dates)
    - Clean any formatting issues or special characters
    - Remove rows with all null values
    - Return structured data with all records

  expected_output: |
    A comprehensive data structure containing:
    - List of all product records with complete column data
    - Each record as a dictionary with keys: sap_article_no, type_of_sale, brewer,
      product_name, pack_type, pack_volume_ml, package_full_name, pack_size,
      old_price, new_price, price_change
    - Metadata: total_record_count, columns_found, parsing_timestamp
    - Any parsing warnings or issues encountered

  agent: excel_parser_agent

extract_effective_date:
  description: |
    Extract the effective date from the input Excel filename to determine when the price changes take effect.

    INSTRUCTIONS:
    - Input: {excel_file_path} (the path to the Excel file)
    - Use the DateExtractorTool to parse the filename and extract the date
    - Expected filename pattern: "TBS Price Change Summary Report - October 13th'25.xlsx"
    - The tool will extract the date portion (e.g., "October 13th'25") and parse it to:
      * ISO format: "2025-10-13" (for internal use)
      * Display format: "October 13, 2025" (for email subject and body)
    - If date extraction fails, the tool will fallback to current date

    This date represents when the price changes become effective (NOT when the flow runs).
    It will be used in the email subject line and body.

  expected_output: |
    A JSON response containing:
    - success: true/false
    - source: "filename" (or "fallback"/"error")
    - effective_date_iso: "2025-10-13" (ISO format YYYY-MM-DD)
    - effective_date_display: "October 13, 2025" (human-readable format)
    - message: Success or error message

    Example:
    {{
      "success": true,
      "source": "filename",
      "filename": "TBS Price Change Summary Report - October 13th'25_formula.xlsx",
      "effective_date_iso": "2025-10-13",
      "effective_date_display": "October 13, 2025",
      "raw_date_string": "October 13th'25",
      "message": "Successfully extracted date: October 13, 2025"
    }}

  agent: excel_parser_agent

generate_formula_excel:
  description: |
    Generate a copy of the input Excel file with formulas added to calculate formatted price change text.

    INSTRUCTIONS:
    - Input: {excel_file_path} (the path to the original Excel file)
    - Output directory: {output_dir} (where to save the formula Excel file)
    - Use the FormulaExcelGeneratorTool to create the Excel file with formulas
    - The formula should be: =PROPER($D[ROW])&" "&$H[ROW]&$L[ROW]&" "&$M[ROW]&"$"&ABS($K[ROW])&" to $"&$J[ROW]
      where [ROW] represents the actual row number (9, 10, 11, etc.)
    - Formula is added to column N for each data row
    - Skip first 7 rows, row 8 has headers, row 9 is the first data row
    - Output filename should follow pattern: "TBS Price Change Summary Report - [Month] [day]th'[YY]_formula.xlsx"
    - The tool will automatically extract the month/date from the input filename
    - Save to the output directory specified

    This creates a version of the Excel file that Mark can open to see the formatted price changes,
    matching his manual workflow of applying formulas in Excel.

  expected_output: |
    A JSON response containing:
    - success: true/false
    - output_file: Full path to the generated Excel file with formulas
    - output_filename: Just the filename of the generated file
    - formulas_added: Count of how many formula rows were added
    - message: Success message with details

    Example:
    {{
      "success": true,
      "output_file": "C:/path/to/output/TBS Price Change Summary Report - October 13th'25_formula.xlsx",
      "output_filename": "TBS Price Change Summary Report - October 13th'25_formula.xlsx",
      "formulas_added": 150,
      "message": "Successfully created formula Excel file with 150 formulas"
    }}

  agent: excel_parser_agent
  context:
    - parse_excel_file

analyze_price_changes:
  description: |
    Analyze and categorize price change data for highlights email using the 6-category system.

    DATA SOURCE:
    - Use the parsed data from the parse_excel_file task (available via context)
    - DO NOT read the Excel file again - all data has already been parsed and is available
    - All product records with complete column data are available from the previous task

    BREWER HIERARCHY AND BRAND MAPPING:
    Map individual brands to their parent brewers using this hierarchy:
    - LABATT: Includes Budweiser, Bud Light, Stella Artois, Corona, Modelo, Becks, Hoegaarden, Michelob, etc.
    - MOLSON: Includes Coors, Molson Canadian, Miller, Heineken, etc.
    - SLEEMAN: Includes Sleeman products, Sapporo, etc.
    - Other: Includes Laker, Peroni, James Ready, Moosehead, Guinness, and any brands not in above categories

    CATEGORIZATION PROCESS:

    FOR EACH PRODUCT, categorize in this order (first match wins):

    1. LICENSEE CHANGES (FIRST PRIORITY):
       - If Type of Sale = "TBS - Licensee" → Add to "LICENSEE CHANGES" category
       - Format: "Product PackSize +/-$X.XX to $YY.YY"
       - ALL licensee products go here, regardless of brewer

       CRITICAL RULES FOR LICENSEE CHANGES:
       - VALIDATION: EVERY single product where Type of Sale = "TBS - Licensee" MUST appear in the "LICENSEE CHANGES" output
       - DO NOT deduplicate products based on product name, brewer, or pack size
       - If a product exists as both "TBS - Retail Price" AND "TBS - Licensee", include BOTH versions in their respective categories
       - Pack size (whether 1, 12, 24, etc.) is IRRELEVANT - include all licensee products regardless
       - Brewer name is IRRELEVANT - include all licensee products regardless
       - Price change percentage is IRRELEVANT - include all licensee products regardless
       - The ONLY criterion is: Type of Sale = "TBS - Licensee"
       - VERIFICATION: Count licensee products in the parsed input data. The "LICENSEE CHANGES" output MUST contain the same count.

       Examples of licensee products that MUST be included:
       - HEINEKEN CANADA INC products (e.g., "Heineken Nv 24B", "Heineken Silver 24B")
       - NICKEL BROOK BREWING COMPANY INC products (e.g., "Headstock Ipa 24B", "Naughty Neighbour 24B")
       - STEAM WHISTLE BREWING INC products (e.g., "Steam Whistle 24C", "Steam Whistle 1")
       - BEAU'S ALL NATURAL BREWING CO LTD products (e.g., "Barnburner Amber Ale 1")
       - ASAHI BREWERIES LTD products (e.g., "Asahi Super Dry 1")
       - Any other product where Type of Sale = "TBS - Licensee"

    2. NEW SKUs:
       - If Type of Sale = "New SKU" → Add to "NEW SKUs" category
       - Format: "Product PackSize $YY.YY"

       CRITICAL RULES FOR NEW SKUs:
       - VALIDATION: EVERY single product where Type of Sale = "New SKU" MUST appear in the "NEW SKUs" output
       - DO NOT deduplicate products based on any criteria
       - DO NOT filter based on brewer, pack size, or price
       - New SKUs are ALWAYS categorized here regardless of brewer hierarchy or other attributes
       - The ONLY criterion is: Type of Sale = "New SKU"
       - VERIFICATION: Count New SKU products in the parsed input data. The "NEW SKUs" output MUST contain the same count.

    3. RETAIL PRODUCTS (Type of Sale = "TBS – Retail Price"):
       - First, assign to parent brewer (LABATT, MOLSON, SLEEMAN, or Other) using hierarchy above
       - Then categorize by price change using ±4% threshold:
         * Calculate percentage: price_percentage = (new_price / old_price) * 100
         * Calculate ratio: price_ratio = new_price / old_price
         * If price_ratio < 0.96 (percentage < 96%): "Begin LTO" (Price DECREASE > 4%)
         * If price_ratio > 1.04 (percentage > 104%): "End LTO" (Price INCREASE > 4%)
           - OR "End LTO & Permanent Change" if price doesn't return to pre-LTO level (requires historical data)
         * If 0.96 ≤ price_ratio ≤ 1.04 (96% ≤ percentage ≤ 104%): "Permanent Changes" (within ±4% threshold)
       - Format: "Product PackSize +/-$X.XX to $YY.YY"

       CRITICAL FILTERING RULES FOR RETAIL PRODUCTS:
       - Include EVERY product where Type of Sale = "TBS – Retail Price"
       - DO NOT filter based on price change magnitude (include $0.01 changes and $20.00 changes alike)
       - DO NOT exclude small changes or insignificant price movements
       - DO NOT skip any products for any reason
       - ALL products from LABATT, MOLSON, SLEEMAN, and Other MUST appear in output
       - VERIFICATION: Count retail products in parsed input data. Output retail products MUST match this count.

    CRITICAL PROCESSING ORDER:
    1. FIRST: Process ALL products where Type of Sale = "TBS - Licensee" into "LICENSEE CHANGES" category
    2. SECOND: Process ALL products where Type of Sale = "New SKU" into "NEW SKUs" category
    3. THIRD: Process retail products (Type of Sale = "TBS – Retail Price") into brewer categories

    DO NOT assign licensee or New SKU products to brewer categories (LABATT, MOLSON, SLEEMAN, Other).
    DO NOT skip any licensee or New SKU products for any reason.

  expected_output: |
    IMPORTANT: Output MUST be valid JSON ONLY - no text before or after, no markdown formatting, no code blocks.
    Start with {{ and end with }}.

    JSON structure:
    {{
      "LABATT": {{
        "Begin LTO": ["Budweiser 30C -$5.50 to $45.99", "MSO 24C -$4 to $44.99"],
        "End LTO": ["Bud Light Lemon Lime 12C +$2 to $29.99"],
        "End LTO & Permanent Change": ["Stella Artois 24B +$3.50 to $52.99"],
        "Permanent Changes": ["Bud Light 28B -$0.50 to $43.49", "Corona Extra 12C +$0.25 to $24.99"]
      }},
      "MOLSON": {{
        "Begin LTO": [],
        "End LTO": [],
        "Permanent Changes": []
      }},
      "SLEEMAN": {{
        "Begin LTO": [],
        "End LTO": [],
        "Permanent Changes": []
      }},
      "Other": {{
        "Begin LTO": ["Laker 24C -$2.00 to $28.99"],
        "End LTO": [],
        "Permanent Changes": ["Guinness 12B +$0.50 to $32.99"]
      }},
      "LICENSEE CHANGES": ["Craft Beer Brand 12C +$1.00 to $28.99"],
      "NEW SKUs": ["New Product Launch 24C $49.99"]
    }}

    Format rules:
    - Each product: "Product PackSize +/-$Amount to $NewPrice"
    - NO explanatory text, NO business context
    - Output parseable JSON only

  agent: data_analyst_agent
  context:
    - parse_excel_file
