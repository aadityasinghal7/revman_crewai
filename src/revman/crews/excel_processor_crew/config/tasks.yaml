parse_excel_file:
  description: |
    Parse the Excel file at {excel_file_path} and extract all price change records.

    INSTRUCTIONS:
    - Skip the first 6 header rows (data starts at row 7)
    - Extract all columns including:
      * SAP Art. No. (Article Number)
      * Type of Sale
      * Brewer
      * Product Name
      * Pack Type (Bottles/Cans)
      * Pack Volume (ml)
      * Package Full Name
      * Pack Size
      * Old Price
      * New Price
      * Increase/(Decrease)
    - Handle data type conversions (numbers, text, dates)
    - Clean any formatting issues or special characters
    - Remove rows with all null values
    - Return structured data with all records

  expected_output: |
    A comprehensive data structure containing:
    - List of all product records with complete column data
    - Each record as a dictionary with keys: sap_article_no, type_of_sale, brewer,
      product_name, pack_type, pack_volume_ml, package_full_name, pack_size,
      old_price, new_price, price_change
    - Metadata: total_record_count, columns_found, parsing_timestamp
    - Any parsing warnings or issues encountered

  agent: excel_parser_agent

extract_effective_date:
  description: |
    Extract the effective date from the input Excel filename to determine when the price changes take effect.

    INSTRUCTIONS:
    - Input: {excel_file_path} (the path to the Excel file)
    - Use the DateExtractorTool to parse the filename and extract the date
    - Expected filename pattern: "TBS Price Change Summary Report - October 13th'25.xlsx"
    - The tool will extract the date portion (e.g., "October 13th'25") and parse it to:
      * ISO format: "2025-10-13" (for internal use)
      * Display format: "October 13, 2025" (for email subject and body)
    - If date extraction fails, the tool will fallback to current date

    This date represents when the price changes become effective (NOT when the flow runs).
    It will be used in the email subject line and body.

  expected_output: |
    A JSON response containing:
    - success: true/false
    - source: "filename" (or "fallback"/"error")
    - effective_date_iso: "2025-10-13" (ISO format YYYY-MM-DD)
    - effective_date_display: "October 13, 2025" (human-readable format)
    - message: Success or error message

    Example:
    {{
      "success": true,
      "source": "filename",
      "filename": "TBS Price Change Summary Report - October 13th'25_formula.xlsx",
      "effective_date_iso": "2025-10-13",
      "effective_date_display": "October 13, 2025",
      "raw_date_string": "October 13th'25",
      "message": "Successfully extracted date: October 13, 2025"
    }}

  agent: excel_parser_agent

generate_formula_excel:
  description: |
    Generate a copy of the input Excel file with formulas added to calculate formatted price change text.

    INSTRUCTIONS:
    - Input: {excel_file_path} (the path to the original Excel file)
    - Output directory: {output_dir} (where to save the formula Excel file)
    - Use the FormulaExcelGeneratorTool to create the Excel file with formulas
    - The formula should be: =PROPER($D[ROW])&" "&$H[ROW]&$L[ROW]&" "&$M[ROW]&"$"&ABS($K[ROW])&" to $"&$J[ROW]
      where [ROW] represents the actual row number (7, 8, 9, etc.)
    - Formula is added to column N for each data row
    - Data starts after 6 header rows (row 7 is typically the first data row)
    - Output filename should follow pattern: "TBS Price Change Summary Report - [Month] [day]th'[YY]_formula.xlsx"
    - The tool will automatically extract the month/date from the input filename
    - Save to the output directory specified

    This creates a version of the Excel file that Mark can open to see the formatted price changes,
    matching his manual workflow of applying formulas in Excel.

  expected_output: |
    A JSON response containing:
    - success: true/false
    - output_file: Full path to the generated Excel file with formulas
    - output_filename: Just the filename of the generated file
    - formulas_added: Count of how many formula rows were added
    - message: Success message with details

    Example:
    {{
      "success": true,
      "output_file": "C:/path/to/output/TBS Price Change Summary Report - October 13th'25_formula.xlsx",
      "output_filename": "TBS Price Change Summary Report - October 13th'25_formula.xlsx",
      "formulas_added": 150,
      "message": "Successfully created formula Excel file with 150 formulas"
    }}

  agent: excel_parser_agent
  context:
    - parse_excel_file

analyze_price_changes:
  description: |
    Analyze and categorize price change data for highlights email using the 6-category system.

    BREWER HIERARCHY AND BRAND MAPPING:
    Map individual brands to their parent brewers using this hierarchy:
    - LABATT: Includes Budweiser, Bud Light, Stella Artois, Corona, Modelo, Becks, Hoegaarden, Michelob, etc.
    - MOLSON: Includes Coors, Molson Canadian, Miller, Heineken, etc.
    - SLEEMAN: Includes Sleeman products, Sapporo, etc.
    - Other: Includes Laker, Peroni, James Ready, Moosehead, Guinness, and any brands not in above categories

    PRIMARY CATEGORIZATION:
    1. Group retail products by Parent Brewer (LABATT, MOLSON, SLEEMAN, Other)
       - Use the brand mapping above to assign each product to the correct parent brewer
       - If a product's brewer is not explicitly listed, assign to "Other"
    2. Within each brewer, categorize changes using ±4% threshold rules:
       - "Permanent Change" - 96% ≤ new price ≤ 104% of old price (Type of Sale = TBS – Retail Price)
       - "Begin LTO" - new price < 96% of old price (>4% decrease, Type of Sale = TBS – Retail Price)
       - "End LTO" - new price > 104% of old price (>4% increase, Type of Sale = TBS – Retail Price)
       - "End LTO & Permanent Change" - Same as End LTO, but price does not return to pre-LTO level (requires historical check)
       - "New SKU" - Clearly marked in the file
       - "Licensee Change" - Type of Sale = TBS - Licensee

    FOR EACH PRODUCT:
    - Calculate: price_ratio = new_price / old_price
    - Check: Type of Sale field
    - Determine final price (New Price)
    - Apply categorization rules:
      * If Type of Sale = "TBS - Licensee": "Licensee Change"
      * If marked as New SKU: "New SKU"
      * If price_ratio < 0.96: "Begin LTO"
      * If price_ratio > 1.04: "End LTO" (or "End LTO & Permanent Change" if historical data shows not returning to pre-LTO)
      * If 0.96 ≤ price_ratio ≤ 1.04: "Permanent Change"
    - Format as: "Product Name PackSize +/-$X.XX to $YY.YY" (NO context or commentary)

  expected_output: |
    Structured categorization dictionary with format:
    {{
      "LABATT": {{
        "Begin LTO": [
          "Budweiser 30C -$5.50 to $45.99",
          "MSO 24C -$4 to $44.99",
          ...
        ],
        "End LTO": [
          "Bud Light Lemon Lime 12C +$2 to $29.99",
          ...
        ],
        "End LTO & Permanent Change": [
          "Stella Artois 24B +$3.50 to $52.99",
          ...
        ],
        "Permanent Changes": [
          "Bud Light 28B -$0.50 to $43.49",
          "Corona Extra 12C +$0.25 to $24.99",
          ...
        ]
      }},
      "MOLSON": {{
        "Begin LTO": [...],
        "End LTO": [...],
        "Permanent Changes": [...]
      }},
      "SLEEMAN": {{
        "Begin LTO": [...],
        "End LTO": [...],
        "Permanent Changes": [...]
      }},
      "Other": {{
        "Begin LTO": [
          "Laker 24C -$2.00 to $28.99",
          ...
        ],
        "End LTO": [...],
        "Permanent Changes": [
          "Guinness 12B +$0.50 to $32.99",
          ...
        ]
      }},
      "LICENSEE CHANGES": [
        "Craft Beer Brand 12C +$1.00 to $28.99",
        ...
      ],
      "NEW SKUs": [
        "New Product Launch 24C $49.99",
        ...
      ]
    }}

    Each entry should be:
    - Formatted as: Product PackSize +/-$Amount to $NewPrice
    - NO business context or explanatory notes
    - Categorized using ±4% threshold rules above
    - Ready for direct insertion into email template

  agent: data_analyst_agent
  context:
    - parse_excel_file

validate_data_quality:
  description: |
    PLACEHOLDER TASK - Minimal validation for now. Comprehensive validation will be added in a future phase.

    For now, simply:
    1. Accept the categorized price change data from the previous task
    2. Perform basic checks (data exists, not empty)
    3. Pass through the categorized data unchanged

    CRITICAL: You MUST output BOTH a minimal validation report AND the original categorized data unchanged.

  expected_output: |
    A JSON object containing BOTH minimal validation results and the UNCHANGED categorized data:
    {{
      "validation": {{
        "status": "PASS",
        "summary": "Placeholder validation - data passed through"
      }},
      "categorized_data": {{
        "LABATT": {{
          "Begin LTO": [
            "Budweiser 30C -$5.50 to $45.99",
            ...
          ],
          "End LTO": [...],
          "End LTO & Permanent Change": [...],
          "Permanent Changes": [...]
        }},
        "MOLSON": {{
          "Begin LTO": [...],
          "End LTO": [...],
          "Permanent Changes": [...]
        }},
        "SLEEMAN": {{
          "Begin LTO": [...],
          "End LTO": [...],
          "Permanent Changes": [...]
        }},
        "LICENSEE CHANGES": [...],
        "NEW SKUs": [...]
      }}
    }}

    IMPORTANT: The categorized_data section must contain the COMPLETE, UNCHANGED price change data from the analyze_price_changes task.
    This is a passthrough task for now. Comprehensive validation will be added in a future phase.

  agent: data_validator_agent
  context:
    - parse_excel_file
    - analyze_price_changes
