parse_excel_file:
  description: |
    Parse the Excel file at {excel_file_path} and extract all price change records.

    INSTRUCTIONS:
    - Skip the first 7 rows, row 8 contains headers, data starts at row 9
    - Extract all columns including:
      * SAP Art. No. (Article Number)
      * Type of Sale
      * Brewer
      * Product Name
      * Pack Type (Bottles/Cans)
      * Pack Volume (ml)
      * Package Full Name
      * Pack Size
      * Old Price
      * New Price
      * Increase/(Decrease)
    - Handle data type conversions (numbers, text, dates)
    - Clean any formatting issues or special characters
    - Remove rows with all null values
    - Return structured data with all records

  expected_output: |
    A comprehensive data structure containing:
    - List of all product records with complete column data
    - Each record as a dictionary with keys: sap_article_no, type_of_sale, brewer,
      product_name, pack_type, pack_volume_ml, package_full_name, pack_size,
      old_price, new_price, price_change
    - Metadata: total_record_count, columns_found, parsing_timestamp
    - Any parsing warnings or issues encountered

  agent: excel_parser_agent

extract_effective_date:
  description: |
    Extract the effective date from the input Excel filename to determine when the price changes take effect.

    INSTRUCTIONS:
    - Input: {excel_file_path} (the path to the Excel file)
    - Use the DateExtractorTool to parse the filename and extract the date
    - Expected filename pattern: "TBS Price Change Summary Report - October 13th'25.xlsx"
    - The tool will extract the date portion (e.g., "October 13th'25") and parse it to:
      * ISO format: "2025-10-13" (for internal use)
      * Display format: "October 13, 2025" (for email subject and body)
    - If date extraction fails, the tool will fallback to current date

    This date represents when the price changes become effective (NOT when the flow runs).
    It will be used in the email subject line and body.

  expected_output: |
    A JSON response containing:
    - success: true/false
    - source: "filename" (or "fallback"/"error")
    - effective_date_iso: "2025-10-13" (ISO format YYYY-MM-DD)
    - effective_date_display: "October 13, 2025" (human-readable format)
    - message: Success or error message

    Example:
    {{
      "success": true,
      "source": "filename",
      "filename": "TBS Price Change Summary Report - October 13th'25_formula.xlsx",
      "effective_date_iso": "2025-10-13",
      "effective_date_display": "October 13, 2025",
      "raw_date_string": "October 13th'25",
      "message": "Successfully extracted date: October 13, 2025"
    }}

  agent: excel_parser_agent

generate_formula_excel:
  description: |
    Generate a copy of the input Excel file with formulas added to calculate formatted price change text.

    INSTRUCTIONS:
    - Input: {excel_file_path} (the path to the original Excel file)
    - Output directory: {output_dir} (where to save the formula Excel file)
    - Use the FormulaExcelGeneratorTool to create the Excel file with formulas
    - The formula should be: =PROPER($D[ROW])&" "&$H[ROW]&$L[ROW]&" "&$M[ROW]&"$"&ABS($K[ROW])&" to $"&$J[ROW]
      where [ROW] represents the actual row number (9, 10, 11, etc.)
    - Formula is added to column N for each data row
    - Skip first 7 rows, row 8 has headers, row 9 is the first data row
    - Output filename should follow pattern: "TBS Price Change Summary Report - [Month] [day]th'[YY]_formula.xlsx"
    - The tool will automatically extract the month/date from the input filename
    - Save to the output directory specified

    This creates a version of the Excel file that Mark can open to see the formatted price changes,
    matching his manual workflow of applying formulas in Excel.

  expected_output: |
    A JSON response containing:
    - success: true/false
    - output_file: Full path to the generated Excel file with formulas
    - output_filename: Just the filename of the generated file
    - formulas_added: Count of how many formula rows were added
    - message: Success message with details

    Example:
    {{
      "success": true,
      "output_file": "C:/path/to/output/TBS Price Change Summary Report - October 13th'25_formula.xlsx",
      "output_filename": "TBS Price Change Summary Report - October 13th'25_formula.xlsx",
      "formulas_added": 150,
      "message": "Successfully created formula Excel file with 150 formulas"
    }}

  agent: excel_parser_agent
  context:
    - parse_excel_file

analyze_price_changes:
  description: |
    Categorize ALL price change data into 5 categories WITHOUT any grouping by brewer.
    Brewer grouping will be handled by the email_builder_crew.

    ================================================================================================
    CRITICAL: EXTRACT FORMULA EXCEL FILE PATH FROM PREVIOUS TASK CONTEXT
    ================================================================================================
    Before running the PriceCategorizationTool, you MUST extract the file path from the previous task:

    1. Look at the task context from the "generate_formula_excel" task (previous task in the workflow)
    2. Find the JSON output containing the "output_file" field
    3. Extract the EXACT file path string from the "output_file" field
    4. Use that EXACT path as the file_path parameter when calling PriceCategorizationTool

    DO NOT:
    - Make up a file path
    - Hardcode a file path like "data/output/TBS_Price_Change_Formula_20250113.xlsx"
    - Guess the filename based on today's date
    - Use any path other than the one from the previous task's output

    WHAT TO LOOK FOR IN CONTEXT:
    The generate_formula_excel task returns JSON like this:
    {{
      "success": true,
      "output_file": "C:/Users/Y946107/OneDrive - Anheuser-Busch InBev/FY25/Personal git repo/RevMan-POC-Crew/revman/data/output/TBS Price Change Summary Report - October 13th'25_formula.xlsx",
      "output_filename": "TBS Price Change Summary Report - October 13th'25_formula.xlsx",
      "formulas_added": 150,
      "message": "Successfully created formula Excel file with 150 formulas"
    }}

    You need to extract the value of "output_file" which contains the full absolute path to the formula Excel file.

    EXAMPLE:
    - Find in context: "output_file": "C:/full/path/to/data/output/TBS Price Change Summary Report - October 13th'25_formula.xlsx"
    - Use in tool call: PriceCategorizationTool(file_path="C:/full/path/to/data/output/TBS Price Change Summary Report - October 13th'25_formula.xlsx")

    ================================================================================================

    STEP 1: USE PRICE CATEGORIZATION TOOL (MANDATORY FIRST STEP)
    ============================================================
    - FIRST, use the PriceCategorizationTool to automatically categorize all products
    - Pass the formula Excel file path extracted from the generate_formula_excel task (see instructions above)
    - The tool will read the Excel and return ALL products pre-categorized into 5 categories:
      1. Licensee Changes
      2. New SKUs
      3. Permanent Changes
      4. Begin LTO
      5. End LTO
    - The tool automatically calculates price ratios and applies all categorization rules
    - This ensures ALL products (including End LTO) are correctly categorized

    STEP 2: FORMAT THE PRE-CATEGORIZED DATA
    ========================================
    - Take the categorized data from PriceCategorizationTool output
    - Format each product entry as: "Product PackSize +/-$X.XX to $YY.YY"
    - Maintain ALL products from each category - DO NOT filter or skip any products
    - Output as flat JSON with 5 category keys

    ================================================================================================
    CATEGORIZATION RULES - PROCESS IN THIS EXACT ORDER:
    ================================================================================================

    RULE 1: LICENSEE PRODUCTS (Type of Sale = "TBS - Licensee")
    ───────────────────────────────────────────────────────────
    - BEFORE ANY GROUPING: Retrieve ALL rows where Type of Sale = "TBS - Licensee"
    - NO GROUPING happens at this stage
    - NO FILTERING of any kind
    - Format: "Product PackSize +/-$X.XX to $YY.YY"
    - Add to "LICENSEE CHANGES" category

    CRITICAL: The following products MUST ALL appear in output:
    1. HEINEKEN NV 24B (-$6.20 to $54.50)
    2. HEINEKEN SILVER 24B (-$6.20 to $54.50)
    3. HEADSTOCK IPA 24B (-$4.00 to $61.88)
    4. WICKED AWESOME IPA 24B (-$4.00 to $61.88)
    5. HEADSTOCK IPA 1 (+$0.25 to $3.30)
    6. STEAM WHISTLE 24C (+$1.00 to $51.99)
    7. BARNBURNER AMBER ALE 1 (+$2.22 to $153.50)
    8. NAUGHTY NEIGHBOUR 24B (+$4.00 to $65.88)
    9. NICKEL BROOK LAGER 24B (+$4.00 to $57.00)
    10. ASAHI SUPER DRY 1 (+$4.99 to $123.00)
    11. STEAM WHISTLE 1 (+$5.00 to $145.95)
    12. DELIRIUM RED 1 (+$6.24 to $214.16)

    VALIDATION:
    - Count products with Type of Sale = "TBS - Licensee" in input: MUST be 12
    - Count products in your "LICENSEE CHANGES" output: MUST be 12
    - If counts don't match, you FAILED - re-process until you get all 12

    ───────────────────────────────────────────────────────────

    RULE 2: NEW SKU PRODUCTS (Type of Sale = "New SKU")
    ───────────────────────────────────────────────────────────
    - BEFORE ANY GROUPING: Retrieve ALL rows where Type of Sale = "New SKU"
    - NO GROUPING happens at this stage
    - NO FILTERING of any kind
    - Format: "Product PackSize $YY.YY"
    - Add to "NEW SKUs" category

    VALIDATION:
    - Count products with Type of Sale = "New SKU" in input
    - Count products in your "NEW SKUs" output
    - Counts MUST match exactly

    ───────────────────────────────────────────────────────────

    RULE 3: RETAIL - PERMANENT CHANGE (Type of Sale = "TBS – Retail Price" AND 96% ≤ new price ≤ 104% of old price)
    ───────────────────────────────────────────────────────────
    - For products where Type of Sale = "TBS – Retail Price"
    - Calculate percentage as: (new_price / old_price) * 100
      (This matches the Column O formula in the generated Excel file)
    - If percentage is between 96 and 104 (inclusive): → "Permanent Changes" category
    - Format: "Product PackSize +/-$X.XX to $YY.YY"
    - NO GROUPING by brewer at this stage

    ───────────────────────────────────────────────────────────

    RULE 4: RETAIL - BEGIN LTO (Type of Sale = "TBS – Retail Price" AND new price < 96% of old price)
    ───────────────────────────────────────────────────────────
    - For products where Type of Sale = "TBS – Retail Price"
    - Calculate percentage as: (new_price / old_price) * 100
    - If percentage < 96: → "Begin LTO" category
    - Format: "Product PackSize +/-$X.XX to $YY.YY"
    - NO GROUPING by brewer at this stage

    ───────────────────────────────────────────────────────────

    <critical>
    RULE 5: RETAIL - END LTO (Type of Sale = "TBS – Retail Price" AND new price > 104% of old price)
    ───────────────────────────────────────────────────────────
    - For products where Type of Sale = "TBS – Retail Price"
    - Calculate percentage as: (new_price / old_price) * 100
    - If percentage > 104: → "End LTO" category
    - Format: "Product PackSize +/-$X.XX to $YY.YY"
    - NO GROUPING by brewer at this stage

    DO NOT SKIP END LTO PRODUCTS! If any products have price ratio > 104% (ratio > 1.04),
    they MUST be included in the "End LTO" category. This is equally important as all other categories.
    </critical>

    ================================================================================================
    IMPORTANT NOTES:
    ================================================================================================
    <mandatory>
    - The PriceCategorizationTool automatically reads Column O (Price Ratio %) from the formula Excel
    - All categorization logic is handled by the tool - you just need to format the output
    - DO NOT manually categorize or calculate ratios - the tool has already done this correctly
    - Your job is to FORMAT the pre-categorized data into the expected JSON structure
    </mandatory>

    <important>
    PERCENTAGE CLARIFICATION:
    - 104% means a ratio of 1.04 (new_price / old_price = 1.04), NOT a 4% increase
    - Example: old_price=$10.00, new_price=$11.00 → ratio=1.10 → 110% → End LTO category
    - Example: old_price=$50.00, new_price=$55.00 → ratio=1.10 → 110% → End LTO category
    - Example: old_price=$100.00, new_price=$96.00 → ratio=0.96 → 96% → Permanent Changes category
    - Example: old_price=$100.00, new_price=$95.00 → ratio=0.95 → 95% → Begin LTO category
    </important>

    - GROUPING by brewer (LABATT, MOLSON, SLEEMAN, OTHER) applies ONLY to Rules 3, 4, 5
    - The grouping logic will be handled by the email_builder_crew, NOT here
    - DO NOT group licensee or new SKU products by brewer
    - DO NOT apply any filtering - include ALL products that match each rule

  expected_output: |
    IMPORTANT: Output MUST be valid JSON ONLY - no text before or after, no markdown formatting, no code blocks.
    Start with {{ and end with }}.

    FLAT JSON STRUCTURE (NO BREWER GROUPING):
    {{
      "LICENSEE CHANGES": [
        "Heineken Nv 24B -$6.20 to $54.50",
        "Heineken Silver 24B -$6.20 to $54.50",
        "Headstock Ipa 24B -$4.00 to $61.88",
        "Wicked Awesome Ipa 24B -$4.00 to $61.88",
        "Headstock Ipa 1 +$0.25 to $3.30",
        "Steam Whistle 24C +$1.00 to $51.99",
        "Barnburner Amber Ale 1 +$2.22 to $153.50",
        "Naughty Neighbour 24B +$4.00 to $65.88",
        "Nickel Brook Lager 24B +$4.00 to $57.00",
        "Asahi Super Dry 1 +$4.99 to $123.00",
        "Steam Whistle 1 +$5.00 to $145.95",
        "Delirium Red 1 +$6.24 to $214.16"
      ],
      "NEW SKUs": [
        "New Product Launch 24C $49.99"
      ],
      "Permanent Changes": [
        "Bud Light 28B -$0.50 to $43.49",
        "Corona Extra 12C +$0.25 to $24.99",
        "Molson Canadian 24C +$0.50 to $38.99"
      ],
      "Begin LTO": [
        "Budweiser 30C -$5.50 to $45.99",
        "Coors Light 28B -$4.00 to $39.49",
        "Miller High Life 24B -$4.00 to $35.99",
        "Laker 24C -$2.00 to $28.99"
      ],
      "End LTO": [
        "Bud Light Lemon Lime 12C +$2.00 to $29.99",
        "Stella Artois 24B +$3.50 to $52.99"
      ]
    }}

    <critical>
    CRITICAL REQUIREMENTS - OUTPUT VALIDATION:
    </critical>
    - NO brewer grouping (LABATT, MOLSON, SLEEMAN, OTHER) in this output
    - Brewer grouping will be done by email_builder_crew
    - ALL 12 licensee products MUST appear in "LICENSEE CHANGES" list
    - ALL products in each category (no filtering)
    - Format: "Product PackSize +/-$Amount to $NewPrice"
    - NO explanatory text, NO business context
    - Output parseable JSON only

    <critical>
    ALL 5 CATEGORIES MUST BE PRESENT IN OUTPUT:
    - ALL 5 category keys must exist in the JSON output: "LICENSEE CHANGES", "NEW SKUs", "Permanent Changes", "Begin LTO", "End LTO"
    - If no products match a category, the array can be empty: []
    - If products exist matching a category's criteria, that category's array MUST NOT be empty
    - SPECIAL VALIDATION FOR END LTO: If ANY products have price ratio > 104% (new_price/old_price > 1.04),
      the "End LTO" array MUST contain those products. An empty "End LTO" array when such products exist is a FAILURE.
    </critical>

  agent: data_analyst_agent
  context:
    - parse_excel_file
