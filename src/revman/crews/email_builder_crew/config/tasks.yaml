write_highlights_content:
  description: |
    Transform the categorized price change data into a complete email with subject line, opening text, and highlights.

    INPUT DATA (provided via inputs):
    - effective_date: {effective_date}
    - price_changes_categorized: {price_changes_categorized}
    - pricing_forecast_analysis: {pricing_forecast_analysis} (optional - may be empty)

    INPUT DATA STRUCTURE:
    The input is a FLAT JSON structure with 5 categories (NO brewer grouping yet):
    {{
      "LICENSEE CHANGES": [...list of all licensee products...],
      "NEW SKUs": [...list of new SKU products...],
      "Permanent Changes": [...list of retail products with 96-104% price ratio...],
      "Begin LTO": [...list of retail products with <96% price ratio...],
      "End LTO": [...list of retail products with >104% price ratio...]
    }}

    PRICING FORECAST ANALYSIS DATA STRUCTURE (optional):
    {{
      "top_10_notable_changes": [
        {{
          "sku": "Product Name Details",
          "brand": "Brand Name",
          "pack_size": "24B",
          "current_price": 45.99,
          "forecasted_price": 48.50,
          "price_change_dollars": 2.51,
          "forecasted_change_pct": 5.46,
          "z_score": 2.3,
          "significance": "2.3σ"
        }},
        ...
      ],
      "total_anomalies_detected": 15,
      "threshold_used": 1.5
    }}

    YOUR JOB:
    1. Take "LICENSEE CHANGES" and "NEW SKUs" - keep them as-is (no grouping)
    2. Take "Permanent Changes", "Begin LTO", "End LTO" - group these by brewer using hierarchy below
    3. Build the email output with brewer-grouped sections
    4. If pricing_forecast_analysis is provided and has "top_10_notable_changes", add a "PRICING TREND FORECAST" section at the end (after NEW SKUs, before closing)

    BREWER GROUPING RULES (applies ONLY to "Permanent Changes", "Begin LTO", "End LTO"):
    For each product in these categories, determine which brewer it belongs to:
    - LABATT: Budweiser, Bud Light, Stella Artois, Corona, Modelo, Becks, Hoegaarden, Michelob, Mill St, etc.
    - MOLSON: Coors, Molson Canadian, Miller, Heineken, Creemore, etc.
    - SLEEMAN: Sleeman, Sapporo, Colt 45, etc.
    - Other: Laker, Peroni, James Ready, Moosehead, Guinness, Steam Whistle (retail), Muskoka, Beaus, Faxe, Gone Fishin, Longhorn, Rough Stock, and all others not in above categories

    CRITICAL: Do NOT use placeholder values or make up data. Use ACTUAL DATA from the input.

    REQUIRED STRUCTURE:
    1. Subject Line: "TBS Price Change Summary – Effective {effective_date}"
       - Use the provided effective_date (extracted from the filename)
       - Consistent format each week
       - Use em dash (–) not hyphen (-)

    2. Opening Text:
       - Brief paragraph providing context about the price changes
       - Reference the effective date
       - Keep it consistent each week

    3. Highlights Section:
       - Title: "Highlights (Price Before Tax and Deposit)"
       - Pack size notation note: "C = 355mL can, TC = 473mL tall can, B = bottle"
       - For each Brewer (LABATT, MOLSON, SLEEMAN, Other) in that order:
       - Brewer name as header
       - "Begin LTO" section (if applicable) - new price < 96% of old price
       - "End LTO" section (if applicable) - new price > 104% of old price
       - "End LTO & Permanent Change" section (if applicable)
       - "Permanent Changes" section (if applicable) - 96% ≤ new price ≤ 104% of old price
       - Empty line between brewers

    4. After all brewers:
       - "LICENSEE CHANGES" section (if applicable) - Type of Sale = TBS - Licensee
       - "NEW SKUs" section (if applicable) - newly added products

    5. Pricing Trend Forecast Section (OPTIONAL - only if pricing_forecast_analysis is provided):
       - Add this section AFTER "NEW SKUs" and BEFORE the closing signature
       - Title: "PRICING TREND FORECAST – Next Week"
       - Subtitle: "Top 10 Notable Price Changes (Statistically Significant)"
       - Note: "Based on historical trend analysis. Significance measured in standard deviations (σ) from historical patterns."
       - Format as a simple table showing:
         * Product and Pack Size
         * Current price
         * Forecast price
         * Change ($ and %)
         * Significance (σ)
       - Use aligned columns for readability
       - Only include if pricing_forecast_analysis contains "top_10_notable_changes"

    FORMAT EACH LINE:
    Product PackSize +/-$Amount to $FinalPrice

    Examples:
    - "Budweiser 30C -$5.50 to $45.99"
    - "Bud Light Lemon Lime 12C +$2 to $29.99"
    - "Corona 24B +$3 to $50.69"

    FORMAT RULES:
    - Use EXACT format: Product PackSize +/-$Amount to $FinalPrice
    - Do NOT add any business context, commentary, or explanatory notes
    - Present data cleanly without additional interpretation

  expected_output: |
    Complete email in plain text format:

    Subject: TBS Price Change Summary – Effective {effective_date}

    ---

    Dear Team,

    Please find below the TBS price changes effective {effective_date}. This summary includes all price adjustments across our portfolio, organized by brewer and change type.

    Highlights (Price Before Tax and Deposit)

    LABATT
    Begin LTO
    Product lines...

    End LTO
    Product lines...

    End LTO & Permanent Change
    Product lines...

    Permanent Changes
    Product lines...

    MOLSON
    Begin LTO
    Product lines...

    End LTO
    Product lines...

    Permanent Changes
    Product lines...

    SLEEMAN
    Begin LTO
    Product lines...

    Permanent Changes
    Product lines...

    Other
    Begin LTO
    Product lines...

    Permanent Changes
    Product lines...

    LICENSEE CHANGES
    Product lines...

    NEW SKUs
    Product lines...

    PRICING TREND FORECAST – Next Week
    Top 10 Notable Price Changes (Statistically Significant)

    Based on historical trend analysis. Significance measured in standard deviations (σ) from historical patterns.

    Product                          Pack    Current    Forecast   Change      Significance
    -------------------------------- ------- ---------- ---------- ----------- ------------
    Budweiser                        24B     $45.99     $48.50     +$2.51 (+5.5%)   2.3σ
    Corona Extra                     12C     $28.99     $26.75     -$2.24 (-7.7%)   2.1σ
    ...

    ---

    Best regards,
    Mark Robinson

    The output should be:
    - Plain text format (NOT HTML)
    - Include subject line with em dash (–)
    - Include opening text with effective date
    - Include pack size notation
    - Properly organized by brewer hierarchy
    - Each product line formatted as: Product PackSize +/-$Amount to $FinalPrice
    - NO business context or commentary (except in pricing forecast section which needs context)
    - If pricing forecast data is provided, include "PRICING TREND FORECAST" section after NEW SKUs
    - Include professional closing
    - Ready to send directly

  agent: email_content_writer_agent
