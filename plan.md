# RevMan TBS Price Change Email Automation - Implementation Plan

## Executive Summary

Automated Revenue Management system that processes TBS (The Beer Store) price change Excel reports and generates formatted email summaries using CrewAI's multi-crew Flow architecture.

**Formula:** `=PROPER($D9)&" "&$H9&$L9&" "&$M9&"$"&ABS($K9)&" to $"&$J9` â†’ Example: `Budweiser 30C -$5.50 to $45.99`

**Flow:** Excel input â†’ Parse & categorize by brewer (LABATT, MOLSON, SLEEMAN) and change type (Begin/End LTO, Permanent Changes) â†’ Generate formatted email â†’ Save to output directory

---

## Business Requirements

### Problem Statement

Mark spends 30-45 minutes weekly processing TBS price change files. The process is formulaic and repeatable, making it ideal for automation. The goal is to eliminate manual work while maintaining the same output format stakeholders expect.

### Success Criteria

- âœ… Automatically process TBS Excel files when received via email
- âœ… Apply Mark's formula logic to generate formatted price change lines
- âœ… Categorize changes by brewer (LABATT, MOLSON, SLEEMAN, etc.)
- âœ… Organize by change type (Begin LTO, End LTO, Permanent Changes)
- âœ… Generate email with subject line, opening text, and highlights in exact template format
- âœ… Reduce processing time from 30-45 minutes to < 2 minutes
- âœ… Maintain 100% format consistency with existing emails

### Input Requirements

**Source:** Email from TBS with attachments:
- **TBS Price Change Summary Report** (primary input)

**Email Trigger:**
- **Subject:** "TBS process"
- **Attachments:** Excel file (.xlsx)

**Excel Structure:**
- **Header Rows:** First 7 rows (skip these), Row 8 contains headers
- **Data Start:** Row 9
- **Total Records:** ~150-200 product price changes

**Required Columns:**

| Column | Name | Description |
|--------|------|-------------|
| A | SAP Art. No. | Article Number |
| B | Type of Sale | e.g., "TBS - Retail Price" |
| C | Brewer | LABATT, MOLSON, SLEEMAN, etc. |
| D | Product Name | e.g., "Budweiser", "Corona" |
| E | Pack Type | Bottles, Cans, Tall Cans |
| F | Pack Volume ml | Volume in milliliters |
| G | Package Full Name | Full package description |
| H | Pack Size | e.g., "30C", "24B", "12TC" |
| I | Old Price | Previous price |
| J | New Price | New price |
| K | Increase/(Decrease) | Price change amount |
| L | B/C/TC | Bottle/Can/Tall Can indicator |
| M | Formula | Mark's Excel formula output (Column N in his file) |

### Output Requirements

The AI agent must produce a draft email with:

#### 1. Subject Line & Opening Text
- **Consistent wording each week** for easy identification
- **Example:** "TBS Price Change Summary â€“ Effective [Date]"
- **Date Source:** Effective date is extracted from the input Excel filename (e.g., "October 13th'25" â†’ "October 13, 2025")
- Opening text should provide brief context about the price changes

#### 2. Highlights Section
- **Grouped by brewer hierarchy:**
  - LABATT (includes Budweiser, Bud Light, Stella Artois, Corona, Modelo, Becks, Hoegaarden, Michelob)
  - MOLSON (includes Coors, Molson Canadian, Miller, Heineken)
  - SLEEMAN (includes Sleeman products, Sapporo)
  - Other (includes Laker, Peroni, James Ready, Moosehead, Guinness, etc.)

- **Example format:**
  ```
  Budweiser 30C +$1 to $59.95
  ```

- **Pack size notation:**
  - C = 355mL can
  - TC = 473mL tall can
  - B = bottle

**Format:** Plain text email content (not HTML)

**Price Change Categorization Logic:**

**Stage 1: Categorization (excel_processor_crew - NO GROUPING)**

1. **Percentage Calculation:** Column O in the formula Excel contains `(new price / old price) * 100`
   - This column is generated by the formula Excel task
   - Use this calculation to determine category thresholds

2. **Categorize by Type of Sale (process in this order):**

   **RULE 1: Type of Sale = "TBS - Licensee"**
   - BEFORE ANY GROUPING: Retrieve ALL rows where Type of Sale = "TBS - Licensee"
   - NO GROUPING happens at this stage
   - NO FILTERING of any kind
   - Add to "LICENSEE CHANGES" category (flat list)

   **RULE 2: Type of Sale = "New SKU"**
   - BEFORE ANY GROUPING: Retrieve ALL rows where Type of Sale = "New SKU"
   - NO GROUPING happens at this stage
   - Add to "NEW SKUs" category (flat list)

   **RULE 3-5: Type of Sale = "TBS â€“ Retail Price"**
   - Calculate percentage: `(new price / old price) * 100` (matches Column O)
   - Categorize based on percentage threshold:
     * **Permanent Changes:** 96% â‰¤ percentage â‰¤ 104%
     * **Begin LTO:** percentage < 96% (price decrease > 4%)
     * **End LTO:** percentage > 104% (price increase > 4%)
   - Add to respective category (flat list, NO brewer grouping yet)

3. **Output Structure:** Flat JSON with 5 categories:
   - "LICENSEE CHANGES" (all 12 licensee products)
   - "NEW SKUs"
   - "Permanent Changes" (retail products, ungrouped)
   - "Begin LTO" (retail products, ungrouped)
   - "End LTO" (retail products, ungrouped)

**Stage 2: Brewer Grouping (email_builder_crew - RETAIL ONLY)**

4. **Group Retail Products by Brewer:**
   - Take "Permanent Changes", "Begin LTO", "End LTO" categories
   - Group by brewer: LABATT, MOLSON, SLEEMAN, OTHER
   - Leave "LICENSEE CHANGES" and "NEW SKUs" ungrouped

5. **No Filtering Rule:** **ALL changes MUST be included** - do not filter out any changes based on magnitude, significance, or any other criteria

**Reference Template:**
`data/templates/Output format.docx` contains actual examples of Mark's email format with real product data

---

## Architecture Overview

### Flow Structure

```
RevManFlow (CrewAI Flow)
    â”‚
    â”œâ”€ FlowState (Pydantic Model)
    â”‚   â”œâ”€ Input: excel_file_path, trigger_date, recipients
    â”‚   â””â”€ Output: email_content, email_subject, metadata
    â”‚
    â”œâ”€ [@start] trigger_flow()
    â”‚   â””â”€ Triggered by: Email with subject "TBS process"
    â”‚   â””â”€ Validates: Input file exists and is readable
    â”‚
    â”œâ”€ [@listen] excel_processing_crew()  â† CREW 1
    â”‚   â”œâ”€ excel_parser_agent
    â”‚   â”‚   â”œâ”€ Task: parse_excel_file
    â”‚   â”‚   â”œâ”€ Task: extract_effective_date
    â”‚   â”‚   â””â”€ Task: generate_formula_excel
    â”‚   â””â”€ data_analyst_agent
    â”‚       â””â”€ Task: analyze_price_changes
    â”‚
    â”œâ”€ [@listen] email_generation_crew()  â† CREW 2
    â”‚   â””â”€ email_content_writer_agent
    â”‚       â””â”€ Task: write_highlights_content
    â”‚
    â””â”€ [@listen] save_email_output()
        â””â”€ Saves: .txt, _metadata.json
```

### Flow State & Data Flow

**State:** Input (Excel file path, trigger date, recipients) â†’ Output (email content, subject, metadata)

**Data Flow:** Excel file â†’ Crew 1 (categorization) â†’ Crew 2 (email generation) â†’ Save to `data/output/`

---

## Component Details

### Crew 1: Excel Processor Crew

**Purpose:** Parse Excel file, apply formula logic, and categorize price changes

**Location:** `src/revman/crews/excel_processor_crew/`

#### Components

**Agents:** 2 agents (excel_parser_agent, data_analyst_agent)

**Tasks:** 4 sequential tasks
1. `parse_excel_file` - Extract all product records from Excel (skip 7 rows, headers at row 8, data starts row 9)
2. `extract_effective_date` - Parse effective date from filename for email subject/body
3. `generate_formula_excel` - Create Excel file with Column N (formatted text) and Column O (percentage ratio) formulas
4. `analyze_price_changes` - Categorize into 5 flat categories based on "Type of Sale" field and percentage thresholds

**Key Output:** Flat JSON with 5 categories (no brewer grouping):
- `LICENSEE CHANGES` - All "TBS - Licensee" products
- `NEW SKUs` - All "New SKU" products
- `Permanent Changes` - Retail products with 96-104% price ratio
- `Begin LTO` - Retail products with <96% price ratio (decreases)
- `End LTO` - Retail products with >104% price ratio (increases)

**Implementation Details:** See `src/revman/crews/excel_processor_crew/config/agents.yaml` and `tasks.yaml`

---

### Crew 2: Email Builder Crew

**Purpose:** Transform categorized data into formatted email template

**Location:** `src/revman/crews/email_builder_crew/`

#### Components

**Agents:** 1 agent (email_content_writer_agent)

**Tasks:** 1 task (`write_highlights_content`)
- Receives flat JSON with 5 categories from Excel Processor Crew
- Groups retail products (Permanent Changes, Begin LTO, End LTO) by brewer (LABATT, MOLSON, SLEEMAN, Other)
- Keeps LICENSEE CHANGES and NEW SKUs ungrouped
- Generates complete email with subject line, opening text, and brewer-organized highlights

**Key Output:** Plain text email with:
- Subject: "TBS Price Change Summary â€“ Effective [Date]" (using effective_date from filename)
- Opening paragraph with context
- Highlights organized by brewer, followed by LICENSEE CHANGES and NEW SKUs sections

**Implementation Details:** See `src/revman/crews/email_builder_crew/config/agents.yaml` and `tasks.yaml`

---

## File Structure

```
revman/
â”œâ”€â”€ src/revman/
â”‚   â”œâ”€â”€ main.py                          # Main Flow definition
â”‚   â”œâ”€â”€ crews/
â”‚   â”‚   â”œâ”€â”€ excel_processor_crew/        # Crew 1: Parse & categorize
â”‚   â”‚   â””â”€â”€ email_builder_crew/          # Crew 2: Format email
â”‚   â””â”€â”€ tools/
â”‚       â””â”€â”€ excel_tools.py
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ input/                           # TBS Excel files
â”‚   â”œâ”€â”€ templates/                       # Output format.docx
â”‚   â””â”€â”€ output/                          # Generated .txt, _metadata.json
â”œâ”€â”€ .env                                 # Environment config
â””â”€â”€ pyproject.toml                       # Dependencies
```

**Path Constants:** Defined in `main.py` using `PROJECT_ROOT`, `DATA_DIR`, `INPUT_DIR`, `OUTPUT_DIR`, `TEMPLATE_DIR` with environment variable overrides

---

## Configuration

**Environment Variables:** Configure API keys, data directories, and logging in `.env` file

**Key Settings:**
- `ANTHROPIC_API_KEY` - Required for Claude API access
- `REVMAN_DATA_DIR`, `REVMAN_INPUT_DIR`, `REVMAN_OUTPUT_DIR` - Data file paths
- `LOG_LEVEL`, `LOG_FILE` - Logging configuration

**Dependencies:** See `pyproject.toml` for required packages (crewai, pandas, openpyxl, python-docx)

---

## Execution

### Running the Flow

**Current (Manual):**
```bash
crewai run  # From project root: revman/
```

**Future (Email Trigger):**
- Monitor inbox for emails with subject "TBS process" containing Excel attachment
- Auto-extract and process Excel file
- Implementation via Microsoft Graph API or IMAP polling

---

## Output

### Generated Files

The flow saves three files to `data/output/`:

**1. Email Content (.txt)** - Plain text email ready to send (e.g., `price_change_email_2025-11-07.txt`)

**2. Formula Excel File (.xlsx)** - Copy of input Excel with formulas in Column N (formatted text) and Column O (percentage ratio)

**3. Metadata (.json)** - Email metadata including subject, dates, input file path, and recipients

### Sample Output Structure

```
Subject: TBS Price Change Summary â€“ Effective [Date]

Dear Team,
[Opening paragraph with effective date]

Highlights (Price Before Tax and Deposit)
C = 355mL can, TC = 473mL tall can, B = bottle

LABATT
  Begin LTO | End LTO | Permanent Changes
  [Product lines...]

MOLSON
  Begin LTO | End LTO | Permanent Changes
  [Product lines...]

SLEEMAN / Other
  [Product lines...]

LICENSEE CHANGES
  [All TBS - Licensee products]

NEW SKUs
  [New SKU products]

Best regards,
[Signature]
```

**See:** `data/output/price_change_email_*.txt` for actual generated examples

---

## Testing

**Current Approach:** End-to-end integration testing with real TBS files and manual review

**Future:** Unit tests for Excel parser, formula logic, categorization rules, and email formatting

---

## Implementation Status

### âœ… Completed (POC Phase)

- [x] Flow architecture designed and implemented
- [x] Excel Processor Crew with 2 agents (excel_parser_agent, data_analyst_agent)
- [x] Email Builder Crew with 1 agent
- [x] Formula logic replicated in data_analyst_agent
- [x] Plain text email generation
- [x] File output to data/output/
- [x] Manual trigger via `crewai run`

### ğŸš§ In Progress

- [ ] Enhanced validation rules
- [ ] Custom Excel tools for complex parsing
- [ ] Error handling improvements

### ğŸ“‹ Future Enhancements

**Phase 2: Email Integration**
- [ ] Email trigger setup (subject: "TBS process")
- [ ] Automatic Excel attachment extraction
- [ ] Email sending capability
- [ ] Recipient configuration

**Phase 3: Advanced Features**
- [ ] Historical comparison (current vs previous week)
- [ ] Alert system for unusual price changes
- [ ] Multiple output formats (HTML email option)
- [ ] Approval workflow before sending

**Phase 4: Analytics & Monitoring**
- [ ] Dashboard for monitoring flow executions
- [ ] Price change trend analysis
- [ ] Performance metrics tracking
- [ ] Audit logging

---

## Key Design Decisions

1. **AI Agents replicate Excel formula logic** - More flexible than direct formula execution, easier to maintain and extend
2. **Plain text email output** - Matches current workflow, simpler validation
3. **Sequential crew execution** - Clear dependencies, easier debugging
4. **Minimal validation for POC** - Focus on core functionality, enhance later
5. **File-based output** - Safe for POC, human review before sending, provides audit trail

---

## Success Metrics

**Targets:** < 2 min execution (vs 30-45 min manual), 100% accuracy, 100% format compliance, zero manual intervention, complete data coverage

---

## Contact & Support

**Project:** RevMan TBS Price Change Automation
**Owner:** Mark (Revenue Management)
**Technical Contact:** Aaditya Singhal (aaditya.singhal@anheuser-busch.com)

**Documentation:**
- Implementation Plan: `revman/plan.md` (this document)
- Configuration: `revman/.env`
- Crew Definitions: `src/revman/crews/*/config/`

---

**Plan Version:** 2.0
**Date:** November 7, 2025
**Status:** Active - POC Phase Complete
